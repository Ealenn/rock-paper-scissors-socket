<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link href="https://unpkg.com/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css" integrity="sha256-D+ZpDJjhGxa5ffyQkuTvwii4AntFGBZa4jUhSpdlhjM=" crossorigin="anonymous" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <title>Rock Paper Scissors</title>
</head>
<body>
    <div id="app">
        <v-app>
            <v-content>
                <!-- Notification -->
                <v-snackbar
                    :timeout="2000"
                    color="info"
                    :bottom="true"
                    v-model="snackbar"
                >
                {{ haveChoice.pseudo }} {{ i18n.notification.text }}
                </v-snackbar>

                <!-- Pseudo-->
                <v-dialog v-model="dialogPseudo" max-width="500px" persistent>
                    <v-card text-xs-center>
                        <v-card-media
                            src="/img/joystick.png"
                            height="200px"
                        >
                        </v-card-media>
                        <v-card-title>
                            <h3>{{ i18n.username.title }}</h3>
                        </v-card-title>

                        <v-card-text style="padding-top:0">
                                

                                <v-container grid-list-md text-xs-center>
                                    <v-layout row wrap>
                                        <v-flex xs6>
                                                <v-btn depressed :disabled="lang == 'fr'" @click="lang = 'fr'">
                                                    <span class="flag-icon flag-icon-fr mr-2"></span>
                                                    Français
                                                </v-btn>
                                        </v-flex>
                                        <v-flex xs6>
                                                <v-btn depressed :disabled="lang == 'en'" @click="lang = 'en'">
                                                    <span class="flag-icon flag-icon-gb mr-2"></span>
                                                    English
                                                </v-btn>
                                        </v-flex>
                                    </v-layout>
                                </v-container>


                                <v-form ref="form" v-model="validPseudo" v-on:submit.prevent="changePseudo()" lazy-validation>
                                    <v-text-field
                                        v-model="myPseudo"
                                        :rules="[v => !!v || 'Name is required', v => v.length <= 10 || 'Name must be less than 10 characters']"
                                        counter="10"
                                        :label="i18n.username.field"
                                        required
                                    ></v-text-field>
                                
                                    <div class="text-xs-center">
                                        <v-btn
                                            depressed
                                            color="primary"
                                            :disabled="!validPseudo"
                                            @click="changePseudo()"
                                        >
                                            {{ i18n.username.submit }}
                                        </v-btn>
                                        <v-btn flat @click="myPseudo = ''">{{ i18n.username.clear }}</v-btn>
                                    </div>
                                </v-form>
                        </v-card-text>
                    </v-card>
                </v-dialog>

                <!-- Game -->
                <v-container grid-list-md text-xs-center>
                    <v-layout row wrap>

                        <!-- GITHUB -->
                        <v-flex xs12 class="text-xs-right" v-if="game.player.length == 1">
                                <a href="https://github.com/Ealenn/rock-paper-scissors-socket" style="text-decoration: none">
                                    <v-btn
                                        depressed
                                        color="grey"
                                        class="white--text"
                                    >
                                        View on GitHub
                                        <v-icon right dark>fab fa-github</v-icon>
                                    </v-btn>
                                </a>
                        </v-flex>

                        <!-- AWAIT -->
                        <v-flex xs12 v-if="game.player.length == 1">
                            <v-card>
                                    <v-toolbar color="light-blue" dark flat>
                                        <v-toolbar-title>{{ i18n.await.title }}</v-toolbar-title>
                                        <v-spacer></v-spacer>
                                    </v-toolbar>
                                    
                                    <v-card-text primary-title>
                                        <div style="margin:auto">

                                            <div>
                                                <v-avatar size="128px">
                                                    <img src="/img/spinner.gif" />
                                                  </v-avatar>
                                                
                                                <h4>{{ i18n.await.title }}</h4>
                                            </div>

                                            <hr>

                                            <div class="text-xs-center">{{ i18n.await.invite }}</div>
                                            <div class="text-xs-center">{{ i18n.await.warning }}</div>
                                            <div class="text-xs-center">
                                                    <v-tooltip top>
                                                        <v-btn slot="activator" depressed class="btn-copy-link" :data-clipboard-text="sharedLink">{{ sharedLink }}</v-btn>
                                                        <span>{{ i18n.await.clipboard.description }}</span>
                                                    </v-tooltip>
                                            </div>

                                            <div class="mt-3">
                                                <a :href="'https://www.facebook.com/sharer/sharer.php?u=' + sharedLink" target="_BLANC" style="text-decoration: none">
                                                    <v-btn depressed style="background:#3b5999" class="white--text">Facebook</v-btn>
                                                </a>
                                                <a :href="'https://twitter.com/home?status=' + sharedLink" target="_BLANC" style="text-decoration: none">
                                                    <v-btn depressed style="background:#55acee" class="white--text">Twitter</v-btn>
                                                </a>
                                                
                                                <v-tooltip top>
                                                    <v-btn slot="activator" depressed class="btn-copy-link white--text" :data-clipboard-text="sharedLink"  style="background:#3C3C3C">{{ i18n.await.clipboard.title }}</v-btn>
                                                    <span>{{ i18n.await.clipboard.description }}</span>
                                                </v-tooltip>
                                            </div>
                                        </div>
                                    </v-card-text>
                                    <p>
                                    </p>
                            </v-card>
                        </v-flex>

                        <!-- QRCode -->
                        <v-flex xs12 v-if="game.player.length == 1">
                            <v-card>
                                    <v-toolbar color="light-blue" dark flat>
                                        <v-toolbar-title>{{ i18n.qrcode.title }}</v-toolbar-title>
                                        <v-spacer></v-spacer>
                                    </v-toolbar>
                                    
                                    <v-card-title primary-title>
                                        <div style="margin:auto">
                                            <canvas id="qr"></canvas>
                                            <hr>
                                            <h4>{{ i18n.qrcode.description }}</h4>
                                        </div>
                                    </v-card-title>
                            </v-card>
                        </v-flex>

                        <!-- GAME -->
                        <v-flex xs12 v-if="game.player.length == 2">
                            <v-card>
                                    <v-toolbar color="light-green" dark flat>
                                        <v-toolbar-title>{{ i18n.game.title }}</v-toolbar-title>
                                        <v-spacer></v-spacer>
                                    </v-toolbar>

                                    <!-- AWAIT/CONTINUE -->
                                    <div class="mt-5 mb-2" v-if="!showAction">
                                            <h3 v-if="!results.win">{{ i18n.game.waiting }}</h3>
                                            <v-layout row wrap>

                                                <v-flex xs6 v-for="player in results.player" v-if="results.win">
                                                    <h3>{{ player.pseudo }}<v-chip color="primary" text-color="white" v-if="me.idPlayer == player.idPlayer">{{ i18n.game.me }}</v-chip></h3>
                                                    <v-icon style="font-size: 7em">{{ getIcon(player.choice) }}</v-icon>
                                                </v-flex>

                                                <v-flex xs6 v-for="player in game.player" v-if="!results.win">
                                                    <h3>{{ player.pseudo }}<v-chip color="primary" text-color="white" v-if="me.idPlayer == player.idPlayer">{{ i18n.game.me }}</v-chip></h3>
                                                    <v-icon style="font-size: 7em" v-if="me.idPlayer == player.idPlayer">{{ getIcon(myChoice) }}</v-icon>
                                                    <v-icon style="font-size: 7em" v-else>{{ blinkIcon }}</v-icon>
                                                </v-flex>

                                                <v-flex xs12 class="mt-5" v-if="results.win">
                                                    <h1>
                                                        <v-icon>fas fa-trophy</v-icon>
                                                        {{ results.win[lang] }}
                                                        <v-icon>fas fa-trophy</v-icon>
                                                    </h1>
                                                    <h2>{{ results.result[lang] }}</h2>
                                                    <v-btn depressed large @click="setContinue()">{{ i18n.game.continue }}</v-btn>
                                                </v-flex>
                                            </v-layout>
                                    </div>
                                    
                                    <!-- ACTION -->
                                    <div class="pb-3 pt-3" v-if="showAction">

                                        <h2 class="mb-2">{{ i18n.game.action.title }}</h2>

                                        <v-btn
                                        large
                                        depressed
                                        color="blue"
                                        class="white--text"
                                        @click="setChoice(0)"
                                        >
                                            {{ i18n.game.action.rock }}
                                            <v-icon right dark>far fa-hand-rock</v-icon>
                                        </v-btn>

                                        <v-btn
                                        large
                                        depressed
                                        color="blue"
                                        class="white--text"
                                        @click="setChoice(1)"
                                        >
                                            {{ i18n.game.action.paper }}
                                            <v-icon right dark>far fa-hand-paper</v-icon>
                                        </v-btn>

                                        <v-btn
                                        large
                                        depressed
                                        color="blue"
                                        class="white--text"
                                        @click="setChoice(2)"
                                        >
                                            {{ i18n.game.action.scissors }}
                                            <v-icon right dark>far fa-hand-scissors</v-icon>
                                        </v-btn>
                                    </div>
                                    
                                </v-card>
                        </v-flex>

                        <!-- BOTTOM -->
                        <v-flex xs12 sm6 v-if="game.player.length == 2">
                                <v-card color="primary">
                                        <v-toolbar color="light-blue" dark flat>
                                            <v-toolbar-title>{{ i18n.stats.score }}</v-toolbar-title>
                                            <v-spacer></v-spacer>
                                        </v-toolbar>
                                        <v-list two-line subheader>
                                            <v-list-tile v-for="player in game.player">
                                                <v-list-tile-avatar>
                                                    <v-icon class="grey lighten-1 white--text">star</v-icon>
                                                </v-list-tile-avatar>
                                                <v-list-tile-content>
                                                    <v-list-tile-title>{{ player.pseudo }}</v-list-tile-title>
                                                    <v-list-tile-sub-title>{{ player.point }}</v-list-tile-sub-title>
                                                </v-list-tile-content>
                                            </v-list-tile>
                                        </v-list>
                                </v-card>
                            </v-flex>
    
                            <v-flex sm6 v-if="game.player.length == 2">
                                <v-card color="primary">
                                        <v-toolbar color="light-blue" dark flat>
                                            <v-toolbar-title>{{ i18n.stats.allparty }}</v-toolbar-title>
                                            <v-spacer></v-spacer>
                                        </v-toolbar>
                                        <v-list two-line subheader>
                                            <v-list-tile>
                                                <v-list-tile-avatar>
                                                    <v-icon class="grey lighten-1 white--text">group</v-icon>
                                                </v-list-tile-avatar>
                                                <v-list-tile-content>
                                                    <v-list-tile-title>{{ stats.players || 0 }}</v-list-tile-title>
                                                    <v-list-tile-sub-title>{{ i18n.stats.online }}</v-list-tile-sub-title>
                                                </v-list-tile-content>
                                            </v-list-tile>
                                            <v-list-tile>
                                                <v-list-tile-avatar>
                                                    <v-icon class="grey lighten-1 white--text">games</v-icon>
                                                </v-list-tile-avatar>
                                                <v-list-tile-content>
                                                    <v-list-tile-title>{{ stats.party || 0 }}</v-list-tile-title>
                                                    <v-list-tile-sub-title>{{ i18n.stats.party }}</v-list-tile-sub-title>
                                                </v-list-tile-content>
                                            </v-list-tile>
                                        </v-list>
                                </v-card>
                            </v-flex>
                    </v-layout>
                </v-container>
            </v-content>

            <!-- Footer -->
            <v-footer height="auto" class="grey darken-3">
                <v-layout row wrap justify-center>
                    <v-flex xs12 py-3 text-xs-center white--text>
                        &copy;2018 — <strong>Ealen</strong> - Rudy Marchandise
                    </v-flex>
                </v-layout>
            </v-footer>
        </v-app>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vuetify/dist/vuetify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <script>
        var server = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
        var socket = io.connect(server)

        var App = new Vue({
        el: '#app',
            data: {
                lang: 'en',
                validPseudo: true,
                dialogPseudo: true,
                myPseudo: "",
                
                me: {},
                game: {},
                stats: {},
                results: {},

                myChoice: 3,
                showAction: true,
                haveChoice: {},
                snackbar: false,
                blinkIcon: "",

                qrcode: null
            },
            methods: {
                setChoice: function (choice) {
                    socket.emit('choice', {choice})
                    this.myChoice = choice
                    this.showAction = false
                },
                changePseudo: function () {
                    if (this.$refs.form.validate()) {
                        this.dialogPseudo = false
                        socket.emit('changePseudo', {pseudo: this.myPseudo})
                    }
                },
                setContinue: function () {
                    this.myChoice = 3
                    this.results = {}
                    this.showAction = true
                },
                getIcon: function (choice) {
                    var icon = ['far fa-hand-rock', 'far fa-hand-paper', 'far fa-hand-scissors', 'fas fa-question']
                    return icon[choice]
                }
            },
            watch: {
                game: function (val) {
                    this.qrcode = new QRious({
                        element: document.getElementById('qr'),
                        level: 'H',
                        size: 300,
                        value: this.sharedLink
                    });
                }
            },
            computed: {
                sharedLink: function() {
                    return location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/' + this.game.session
                },
                i18n: function () {
                    var fr = {
                        notification: {
                            text: 'a joué'
                        },
                        username: {
                            title: 'Choisissez votre pseudo',
                            field: 'Pseudo',
                            submit: 'Envoyer',
                            clear: 'Effacer'
                        },
                        await: {
                            title: 'En attente d\'un joueur',
                            invite: 'Pour inviter vos amis, cliquez sur le lien ci-dessous pour le copier ou partagez le sur les réseaux sociaux.',
                            warning: 'ATTENTION : Si vous actualisez la page, un nouveau lien sera généré !',
                            clipboard: {
                                title: 'Presse papier',
                                description: 'Copier dans le presse papier'
                            }
                        },
                        qrcode: {
                            title: 'Inviter via QRCode',
                            description: 'Scanne le QRCode pour me rejoindre'
                        },
                        game: {
                            title: 'Jeu',
                            waiting: 'En attente de votre adversaire',
                            me: 'Moi',
                            continue: 'CONTINUER',
                            action: {
                                title: 'Choisissez une action',
                                rock: 'Pierre',
                                paper: 'Feuille',
                                scissors: 'Ciseaux'
                            }
                        },
                        stats: {
                            score: 'Score',
                            allparty: 'Toutes partie',
                            online: 'joueurs en ligne',
                            party: 'parties active'
                        }
                    }

                    var en = {
                        notification: {
                            text: 'have played'
                        },
                        username: {
                            title: 'Choose your username',
                            field: 'Username',
                            submit: 'Submit',
                            clear: 'Clear'
                        },
                        await: {
                            title: 'Waiting for player',
                            invite: 'To invite a friend, copy the link below or share it with the social buttons.',
                            warning: 'WARNING, if you refresh or close the page a new link will be generated !',
                            clipboard: {
                                title: 'Clipboard',
                                description: 'Copy to clipboard'
                            }
                        },
                        qrcode: {
                            title: 'Invite Player with QRCode',
                            description: 'Scan the QRCode for play with me !'
                        },
                        game: {
                            title: 'Game',
                            waiting: 'Waiting for your opponent',
                            me: 'Me',
                            continue: 'CONTINUE',
                            action: {
                                title: 'Choose an action',
                                rock: 'Rock',
                                paper: 'Paper',
                                scissors: 'Scissors'
                            }
                        },
                        stats: {
                            score: 'Score',
                            allparty: 'All party',
                            online: 'players online',
                            party: 'party active'
                        }
                    }

                    if (this.lang == 'fr')
                        return fr
                    
                    return en
                }
            }
        })

        // btn copy link
        var clipboard = new ClipboardJS('.btn-copy-link');
        clipboard.on('success', function(e) {
            console.info('Action:', e.action);
            console.info('Text:', e.text);
            console.info('Trigger:', e.trigger);

            e.clearSelection();
        });

        // Blink Icon
        var i = 0
        var icon = ['far fa-hand-rock', 'far fa-hand-paper', 'far fa-hand-scissors', 'fas fa-question']
        var funcChangeIcon = function () {
            if (i >= icon.length - 1) {
                i = 0
            } else {
                i++
            }
            App.$data.blinkIcon = icon[i]
            setTimeout(function () {funcChangeIcon()}, 100)
        }
        funcChangeIcon()

        // Socket
        <% if (session) { %>
        socket.emit('join', {
            session: "<%= session %>"
        })
        <% } %>

        socket.on('connected', function (data) {
            App.$data.game = data
        })

        socket.on('yourID', function (data) {
            App.$data.me = data
        })

        socket.on('stats', function (data) {
            App.$data.stats = data
        })

        socket.on('haveChoice', function (data) {
            console.log(data)
            App.$data.haveChoice = data
            App.$data.snackbar = true
        })

        socket.on('results', function (data) {
            App.$data.results = data
            App.$data.showContinue = true
        })
    </script>

    <!-- Handle Close Window-->
    <script>
    window.addEventListener("beforeunload", function (e) {
        var confirmationMessage = "\o/";
        e.returnValue = confirmationMessage;     // Gecko, Trident, Chrome 34+
        return confirmationMessage;              // Gecko, WebKit, Chrome <34
    });
    </script>
</body>
</html>